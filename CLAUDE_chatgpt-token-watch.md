# ChatGPT Token Watch 開發進度記錄

## 專案概述
一個監控 ChatGPT 對話 token 使用量的 Chrome 擴充程式，具備即時顯示、警告提醒、自動生成交接摘要等功能。

---

## 2025-01-27 工作記錄

### ✅ 今天完成的工作

#### 1. 建立完整的 Chrome Extension 專案架構
- **Manifest V3 設定檔**：正確設定權限、內容腳本、背景腳本
- **核心檔案結構**：
  - `content.js` - 主要邏輯和 HUD 控制
  - `tokenEstimator.js` - Token 估算模組
  - `popup.html/css/js` - 設定介面
  - `background.js` - 背景服務和通知
  - `styles.css` - HUD 和 UI 樣式

#### 2. 實作核心功能
- **即時 Token 監控**：掃描 ChatGPT 頁面內容並估算 token 使用量
- **SPA 路由相容**：完美支援 ChatGPT 的頁面切換不重載
- **雙重警告系統**：百分比門檻 + 最小剩餘量雙重警示
- **程式碼區塊選項**：可選擇是否將程式碼計入 token 估算

#### 3. HUD 介面設計重大改進
- **從大型 HUD 改為 Compact 膠囊設計**：
  - 預設：小膠囊顯示 `1.2K/8K | 6.8K` 格式
  - 點擊展開：顯示詳細資訊和操作按鈕
  - 響應式設計，手機版自動適配

#### 4. 觸發機制優化
- **移除自動彈窗**：取消 95% 時的自動警告彈窗
- **改為手動觸發**：用戶點擊 HUD 展開後主動選擇生成摘要
- **保留視覺警告**：達到閾值時 HUD 邊框變紅色並有動畫提示

#### 5. 摘要生成品質大幅提升
- **專業化 Seed Prompt**：
  - 改名為「任務接續指南」
  - TL;DR 核心任務摘要
  - 已確立結論 + 待執行任務 + 待解決問題
  - 具體的下一步行動建議
  
- **工作交接報告格式**：
  - 改名為「專案工作交接報告」
  - 執行摘要、關鍵決策記錄、當前狀態總結
  - 下階段工作計劃、技術要點、交接檢查清單

#### 6. 內容品質清理系統
- **聊天用語過濾**：自動移除「超棒」、「太讚」、「哇塞」等表達
- **智能內容提取**：
  - 目標提取（需求語句）
  - 決策提取（建議和結論）
  - 問題提取（未解決疑問）
  - 技術詞彙識別

### 🎯 重要發現和決策

#### 設計決策
1. **Compact HUD 設計**：從佔用大量空間的 HUD 改為小膠囊，大幅改善用戶體驗
2. **手動觸發機制**：讓用戶完全控制摘要生成時機，避免干擾工作流程
3. **任務導向摘要**：從聊天記錄轉為專業工作文件，真正具備可操作性

#### 技術發現
1. **Token 估算策略**：混合字數和字元數的估算方法，準確度較高
2. **SPA 路由處理**：需要監聽 `pushState`/`replaceState` 和 DOM 變化
3. **內容清理重要性**：原始對話包含大量無用資訊，清理後摘要品質顯著提升

#### 用戶體驗改進
1. **非侵入性設計**：小膠囊不遮擋 ChatGPT 介面，只在需要時展開
2. **視覺反饋清晰**：橙色/紅色邊框 + 脈衝動畫，警告狀態一目了然
3. **完全用戶控制**：沒有自動干擾，用戶主動選擇何時生成摘要

### 🚫 遇到的問題

#### 已解決問題
1. **圖示檔案創建**：初始嘗試生成 PNG 檔案失敗，改為文字 placeholder 解決
2. **自動彈窗過於干擾**：用戶反饋後改為手動觸發機制
3. **摘要品質不佳**：包含太多聊天用語，透過內容清理大幅改善

#### 無重大阻礙
今天的開發過程非常順利，沒有遇到無法解決的技術問題。

### 📋 下一步計劃

#### 短期計劃（1-3 天內）
1. **用戶測試和回饋收集**：
   - 在實際 ChatGPT 對話中測試各種場景
   - 收集 HUD 顯示和摘要品質的用戶回饋
   - 測試不同 token 閾值下的表現

2. **細節優化**：
   - 調整 compact HUD 的視覺設計和動畫效果
   - 優化 token 估算精確度
   - 改善程式碼區塊識別的準確性

3. **錯誤處理強化**：
   - 增加更完善的錯誤處理機制
   - 處理 ChatGPT 頁面結構變化的相容性問題

#### 中期計劃（1-2 週內）
1. **功能擴展**：
   - 考慮新增匯出為不同格式（JSON, CSV）的選項
   - 實作摘要模板自定義功能
   - 新增統計數據面板（每日/週/月 token 使用統計）

2. **效能優化**：
   - 優化 DOM 掃描頻率和效率
   - 實作更精確的 token 計算演算法
   - 減少記憶體使用量

3. **擴展平台支援**：
   - 考慮支援其他 AI 對話平台
   - 研究 Firefox 擴充程式移植的可行性

#### 長期願景
1. **智能摘要進化**：使用 AI 進一步優化摘要生成品質
2. **團隊協作功能**：多人共享 token 管理和摘要協作
3. **企業版功能**：加入更多專業功能和客製化選項

### 🏆 專案里程碑

- [x] **v1.0.0**: 基礎架構和核心功能 (2025-01-27)
- [x] **v1.1.0**: Compact HUD 設計和手動觸發 (2025-01-27)  
- [x] **v1.2.0**: 專業化摘要生成和內容清理 (2025-01-27)
- [ ] **v1.3.0**: 用戶測試和穩定性優化 (預計 2025-01-30)
- [ ] **v2.0.0**: 功能擴展和效能優化 (預計 2025-02-10)

### 📝 技術債務和改進事項

1. **程式碼區塊識別**：目前使用正則表達式，可能需要更智能的解析
2. **設定持久化**：考慮加入設定匯出/匯入功能
3. **國際化支援**：目前主要針對繁體中文，可考慮多語言支援
4. **測試覆蓋率**：需要建立自動化測試框架

---

## 關鍵成就

今天成功將一個基本的 token 監控工具，升級為具備專業交接功能的完整解決方案。從用戶體驗到內容品質都有顯著提升，真正達到了「可操作性」的目標。

**最重要的突破**：摘要生成從「對話記錄」轉變為「工作指南」，這讓 ChatGPT Token Watch 從工具升級為真正的工作流程改善方案。

---

## 2025-01-28 工作記錄

### ✅ 今天完成的工作

#### 1. 摘要生成品質大幅優化
- **強化內容清理系統**：
  - 移除分享文案和推廣內容（「網友分享」、「與大家分享開發」）
  - 壓縮冗長表達為簡潔動作（「需要建立一個」→「建立」）
  - 過濾 Meta 層面討論和評價性語言
  - 清除感嘆詞和重複標點符號

- **優化任務提取邏輯**：
  - 動詞導向目標提取（聚焦「開發」、「建立」、「實作」等行動動詞）
  - 技術決策過濾（只保留具體技術指標，移除一般性建議）
  - 專案層面問題篩選（保留架構、實作、技術相關，移除 meta-level 討論）
  - 自動去重複處理

- **精簡摘要格式**：
  - **Seed Prompt**：TL;DR 限制 2-3 句，技術決策直接列出，待辦清單動詞開頭
  - **Handover Report**：具體術語（Chrome Extension MV3、TokenEstimator），簡化交接確認為 5 個核心檢查點
  - **摘要長度優化**：從 800-1200 tokens 降至 400-600 tokens

#### 2. HUD 重大設計改版 - 圓球可拖曳系統
- **圓球設計**：
  - 40px 直徑完美圓形，顯示簡潔 token 數字（如「1.2K」）
  - 三色警示系統：🟢 綠色（正常）→ 🟠 橙色（警告，2秒脈動）→ 🔴 紅色（危險，1.5秒脈動）

- **完整拖曳功能**：
  - 150ms 延遲區分點擊和拖曳操作
  - 邊界限制保持在可視區域內（10px 邊距）
  - localStorage 永久儲存位置記憶
  - 拖曳時視覺反饋（游標變 grabbing）

- **智能展開面板**：
  - 點擊（非拖曳）時展開詳細面板
  - 根據圓球位置自動調整面板展開方向
  - 滑入動畫效果，平滑 0.3秒過渡
  - 關閉按鈕和點擊收起雙重操作

### 🎯 重要發現和決策

#### 設計決策
1. **從 Compact 膠囊改為圓球**：進一步減少介面干擾，提升用戶自主控制
2. **摘要品質優先**：專注任務導向內容，移除所有聊天用語和推廣文字
3. **拖曳 vs 點擊分離**：150ms 延遲完美區分兩種操作，避免誤觸

#### 技術發現
1. **內容清理重要性**：原始對話包含 40-60% 無用資訊，清理後摘要品質顯著提升
2. **拖曳邊界處理**：需要考慮 HUD 尺寸避免超出可視範圍
3. **面板定位挑戰**：根據圓球位置動態調整展開方向，避免遮擋重要元素

#### 用戶體驗突破
1. **完全非侵入性**：40px 圓球最小化介面佔用
2. **位置完全自由**：用戶可拖曳到任意舒適位置並記憶
3. **即時狀態可見**：token 數字和顏色警示即時反映狀態

### 🚫 遇到的問題

#### 已解決問題
1. **拖曳 vs 點擊衝突**：透過時間延遲和移動距離雙重判斷完美解決
2. **位置記憶實作**：使用 localStorage JSON 格式儲存，加入容錯處理
3. **面板定位複雜性**：透過 CSS 選擇器檢測 style 屬性判斷位置

#### 無技術阻礙
今天的開發同樣非常順利，拖曳系統和摘要優化都一次到位。

### 📋 下一步計劃

#### 短期計劃（1-3 天內）
1. **用戶測試新圓球設計**：
   - 測試拖曳功能在不同螢幕尺寸的表現
   - 驗證位置記憶功能的穩定性
   - 收集新摘要品質的實際使用回饋

2. **細節優化和完善**：
   - 調整圓球在不同 ChatGPT 主題下的視覺效果
   - 優化面板展開動畫和響應速度
   - 改善 token 數字顯示格式（考慮千位數顯示）

3. **相容性測試**：
   - 測試新設計在不同瀏覽器的相容性
   - 驗證 ChatGPT 介面更新時的適應性
   - 測試手機版 ChatGPT 的拖曳體驗

#### 中期計劃（1-2 週內）
1. **進階功能開發**：
   - 考慮新增圓球透明度設定
   - 實作雙擊圓球快速操作（如立即生成摘要）
   - 新增圓球主題色彩自定義選項

2. **效能和體驗優化**：
   - 優化拖曳性能，減少 DOM 操作
   - 實作更平滑的動畫效果
   - 考慮新增手勢支援（長按、快速點擊等）

3. **功能擴展準備**：
   - 設計多主題圓球外觀
   - 研究集成更多快捷操作的可能性
   - 準備進階設定選項

#### 長期願景
1. **智能互動進化**：圓球 AI 化，根據對話進度主動調整提醒頻率
2. **多平台統一體驗**：確保圓球設計在所有支援平台的一致性
3. **企業級功能**：團隊共享圓球狀態和集中管理

### 🏆 專案里程碑

- [x] **v1.0.0**: 基礎架構和核心功能 (2025-01-27)
- [x] **v1.1.0**: Compact HUD 設計和手動觸發 (2025-01-27)  
- [x] **v1.2.0**: 專業化摘要生成和內容清理 (2025-01-27)
- [x] **v1.3.0**: 摘要品質優化和內容清理強化 (2025-01-28)
- [x] **v1.4.0**: 圓球可拖曳 HUD 重大設計改版 (2025-01-28)
- [ ] **v1.5.0**: 用戶測試和體驗優化 (預計 2025-01-30)
- [ ] **v2.0.0**: 進階功能和效能優化 (預計 2025-02-10)

### 📝 技術債務和改進事項

1. **動畫性能**：考慮使用 CSS transform 替代部分 JavaScript 動畫
2. **拖曳優化**：研究使用 Pointer Events API 提升觸控相容性  
3. **記憶體管理**：檢查事件監聽器的清理和記憶體洩漏
4. **測試框架**：建立自動化測試以覆蓋拖曳和位置記憶功能

---

## 關鍵成就

### 昨天（2025-01-27）
成功建立完整的 Chrome Extension 架構，從基本 token 監控升級為專業交接工具。

### 今天（2025-01-28）  
**雙重突破**：
1. **摘要品質革命**：從聊天記錄徹底轉型為專業任務指南，內容簡潔度提升 50%
2. **用戶體驗革新**：圓球拖曳設計完全重新定義了 HUD 交互方式，實現最小干擾和最大自由度

**最重要的進步**：ChatGPT Token Watch 從工具進化為真正的**智能工作伴侶**，既不干擾用戶，又提供專業級的工作交接支援。

---

## 2025-01-29 工作記錄

### ✅ 今天完成的工作

#### 1. 修復 16:9 寬螢幕 HUD 不可見問題
- **問題診斷**：HUD 懸浮球在寬螢幕（16:9）上不可見，直式螢幕正常
- **根本原因**：z-index 不足 + 定位計算在寬螢幕失效

#### 2. CSS 定位系統全面優化
- **z-index 大幅提升**：
  - 主 HUD：999999 → 2147483647（最大值）
  - 展開面板：2147483647
  - Toast 通知：2147483646
  - 警告彈窗：2147483645

- **視窗邊界保護**：
  - 添加 max-width: calc(100vw - 20px)
  - 添加 max-height: calc(100vh - 20px)
  - 展開面板改用 fixed 定位避免父元素限制

#### 3. 響應式適配大幅強化
- **16:9 寬螢幕專用適配**：
  ```css
  @media (min-aspect-ratio: 16/9) {
    .ctw-hud { min-width: 40px; min-height: 40px; }
    .ctw-expanded-panel { width: 300px; }
  }
  ```

- **21:9 超寬螢幕支援**：
  ```css
  @media (min-aspect-ratio: 21/9) {
    .ctw-hud { right: max(20px, calc((100vw - 1920px) / 2 + 20px)); }
  }
  ```

#### 4. JavaScript 智能位置校正系統
- **位置驗證函數**：validateHUDPosition() 確保 HUD 永遠在安全區域
- **可見性檢查**：ensureHUDVisibility() 自動檢測並校正位置
- **多重觸發機制**：
  - 窗口調整大小時立即校正
  - 每5秒定期檢查
  - 初始載入延遲1秒校正

#### 5. 專業調試系統
- **寬螢幕自動檢測**：aspect ratio > 1.7 自動啟用調試模式
- **視覺調試標記**：
  - 紅色虛線邊框
  - "DEBUG" 標籤顯示
  - 透明背景便於檢查層級

- **詳細診斷日誌**：
  ```javascript
  // 輸出完整 HUD 狀態資訊
  position: { x, y, width, height }
  viewport: { width, height, aspectRatio }
  isWideScreen, isVisible, zIndex, display
  ```

- **快捷鍵控制**：Ctrl+Shift+D 切換調試模式

### 🎯 重要發現和決策

#### 技術突破
1. **z-index 競爭問題**：ChatGPT 某些元素使用極高 z-index，必須使用最大值 2147483647
2. **寬螢幕定位失效**：預設 right/bottom 定位在超寬螢幕會超出可視範圍
3. **面板定位複雜性**：absolute 定位會被父元素限制，必須改用 fixed

#### 設計決策
1. **自動校正優於手動**：系統自動檢測和修正，用戶無需操作
2. **調試模式預設啟用**：寬螢幕用戶更容易遇到問題，自動提供診斷
3. **多層防護機制**：位置驗證 + 可見性檢查 + 定期校正

### 🚫 遇到的問題

#### 已完全解決
1. **HUD 不可見**：透過 z-index 提升和位置校正完全解決
2. **寬螢幕適配**：專用 media query 和動態定位計算解決
3. **調試困難**：完整調試系統讓問題診斷變得容易

#### 無技術阻礙
這次修復過程非常順利，一次性解決了所有寬螢幕相容性問題。

### 📋 下一步計劃

#### 短期計劃（1-3 天內）
1. **用戶測試新修復**：
   - 在各種寬螢幕比例測試 HUD 顯示
   - 驗證調試功能的實用性
   - 收集不同螢幕配置的用戶回饋

2. **穩定性驗證**：
   - 測試長時間使用的穩定性
   - 驗證位置記憶功能的準確性
   - 檢查效能影響

#### 中期計劃（1-2 週內）
1. **進階響應式優化**：
   - 支援更多特殊螢幕比例
   - 優化超高解析度螢幕的顯示
   - 考慮垂直螢幕的特殊處理

2. **調試功能進化**：
   - 加入更詳細的效能監控
   - 實作遠端診斷功能
   - 建立問題回報機制

### 🏆 專案里程碑

- [x] **v1.0.0**: 基礎架構和核心功能 (2025-01-27)
- [x] **v1.1.0**: Compact HUD 設計和手動觸發 (2025-01-27)  
- [x] **v1.2.0**: 專業化摘要生成和內容清理 (2025-01-27)
- [x] **v1.3.0**: 摘要品質優化和內容清理強化 (2025-01-28)
- [x] **v1.4.0**: 圓球可拖曳 HUD 重大設計改版 (2025-01-28)
- [x] **v1.5.0**: 寬螢幕相容性修復和調試系統 (2025-01-29)
- [ ] **v1.6.0**: 用戶測試和穩定性優化 (預計 2025-01-31)
- [ ] **v2.0.0**: 進階功能和效能優化 (預計 2025-02-10)

### 📝 技術債務和改進事項

1. **效能監控**：新增的定期檢查可能影響效能，需要監控
2. **調試資訊隱私**：確保調試日誌不包含敏感資訊
3. **相容性測試**：需要更多不同螢幕配置的測試數據
4. **錯誤處理**：position 相關異常的更完善處理

---

## 關鍵成就

### 昨天（2025-01-28）
摘要品質革命和圓球拖曳設計，實現最小干擾和最大自由度。

### 今天（2025-01-29）  
**相容性突破**：徹底解決寬螢幕 HUD 不可見問題，從技術修復到用戶體驗優化的完整解決方案。

**最重要的進步**：
1. **問題診斷系統化**：從被動回應到主動檢測和修復
2. **調試功能專業化**：讓技術問題變得可視化和可操作
3. **響應式設計成熟化**：真正支援所有主流螢幕比例

ChatGPT Token Watch 現在是一個**真正跨平台相容**的專業工具，在任何螢幕配置下都能穩定工作。

---

## 2025-09-08 工作記錄 - 多平台通用版升級 + Claude.ai 角色檢測問題

### ✅ 今天完成的工作

#### 1. 多平台架構設計與實作
- **全新 PlatformDetector 系統**：
  - 支援 ChatGPT、Claude、Gemini、Grok 四大平台
  - URL + DOM 雙重檢測機制，確保平台識別準確性
  - 平台特定配置系統 (選擇器、token 限制、角色映射)
  - 調試模式和問題診斷功能

#### 2. TokenEstimator 多平台重構
- **智能適配系統**：
  - 自動載入平台特定配置
  - 多重備用選擇器策略 (primary + fallback)
  - 平台特定的角色檢測邏輯
  - 動態 token 限制調整

#### 3. 權限與配置全面更新
- **Manifest V3 多平台支援**：
  - 擴充程式更名為 "AI Token Watch v2.0.0"
  - 新增 Claude、Gemini、Grok 域名權限
  - 載入順序優化：platformDetector.js → tokenEstimator.js → content.js

#### 4. 核心邏輯適配
- **AITokenWatch 重構**：
  - 平台支援檢查，不支援平台優雅退出
  - 動態 token 限制根據平台自動設定
  - 摘要生成加入平台名稱顯示
  - 全面更新變數命名 (chatGPTTokenWatch → aiTokenWatch)

#### 5. 使用者介面更新
- **設定頁面改版**：
  - 標題更新為 "AI Token Watch"
  - 新增平台支援狀態顯示
  - 版本號升級至 v2.0.0

#### 6. 文件與說明完整更新
- **README.md 大幅改寫**：
  - 多平台支援說明和技術架構圖表
  - 平台特定配置對照表
  - 新增平台支援開發指南
  - 故障排除和調試功能說明

### 🎯 重要技術決策

#### 架構設計決策
1. **模組化設計**：PlatformDetector 獨立模組，便於維護和擴展
2. **配置驅動**：所有平台差異透過配置物件處理，避免硬編碼
3. **向後相容**：保持原有 ChatGPT 功能完全相容
4. **優雅降級**：不支援平台自動停用，不影響整體使用

#### 平台特定配置策略
| 平台 | Token 限制 | 檢測策略 | 內容提取 | 支援狀態 |
|------|----------|----------|---------|---------|
| **ChatGPT** | 8,000 | `data-message-author-role` | `.markdown, .prose` | ✅ 穩定 |
| **Claude** | 200,000 | `data-testid*="message"` | `.font-claude-message` | ⚠️ 不穩定 |
| **Gemini** | 30,000 | DOM + 域名雙重檢測 | `.markdown, .formatted-text` | ✅ 穩定 |
| **Grok** | 25,000 | URL pattern + testid | `[data-testid="tweetText"]` | ✅ 穩定 |

### 🚀 核心突破

#### 1. 統一多平台體驗
- 單一擴充程式支援四大 AI 平台
- 自動平台檢測和配置載入
- 統一的 HUD 操作體驗

#### 2. 智能配置系統
- 動態 token 限制 (8K-200K 根據平台)
- 平台特定的 DOM 選擇器策略
- 自動角色檢測和內容提取

#### 3. 可擴展架構
- 新增平台只需在 platformConfigs 添加配置
- 模組化設計便於維護和擴展
- 完整的調試和診斷功能

### 🎊 里程碑成就

#### v2.0.0 多平台通用版發布
- [x] **ChatGPT 支援** - 完整保留原有功能 ✅
- [x] **Claude 支援** - 200K token 限制 ⚠️ (DOM 檢測不穩定)
- [x] **Gemini 支援** - 30K token 限制 ✅
- [x] **Grok 支援** - 25K token 限制 ✅
- [x] **統一 HUD 體驗** - 圓球拖曳、位置記憶
- [x] **專業摘要生成** - 跨平台任務交接
- [x] **響應式設計** - 寬螢幕完美相容

### 📋 下一步計劃

#### 短期計劃（測試階段）
1. **多平台實際測試**：
   - 在各 AI 平台測試 HUD 顯示和功能
   - 驗證 token 估算準確性
   - 測試平台切換的穩定性

2. **用戶回饋收集**：
   - 收集多平台使用體驗反饋
   - 驗證平台檢測準確性
   - 優化 DOM 選擇器策略

#### 中期計劃（優化階段）
1. **選擇器精確度優化**：
   - 根據實際測試結果調整平台配置
   - 增加更多備用選擇器
   - 提升內容提取準確性

2. **效能優化**：
   - 多平台環境下的效能監控
   - 優化平台檢測效率
   - 減少不必要的 DOM 掃描

#### 長期願景（擴展階段）
1. **更多平台支援**：
   - 考慮支援 Perplexity、You.com 等平台
   - 研究其他新興 AI 對話平台
   - 建立社群貢獻機制

2. **進階功能**：
   - 跨平台使用統計和分析
   - 多平台摘要對比功能
   - 平台間內容遷移工具

### 🏆 專案里程碑更新

- [x] **v1.0.0**: 基礎架構和核心功能 (2025-01-27)
- [x] **v1.1.0**: Compact HUD 設計和手動觸發 (2025-01-27)  
- [x] **v1.2.0**: 專業化摘要生成和內容清理 (2025-01-27)
- [x] **v1.3.0**: 摘要品質優化和內容清理強化 (2025-01-28)
- [x] **v1.4.0**: 圓球可拖曳 HUD 重大設計改版 (2025-01-28)
- [x] **v1.5.0**: 寬螢幕相容性修復和調試系統 (2025-01-29)
- [x] **v2.0.0**: 🎉 **多平台通用版發布** (2025-09-08)
- [ ] **v2.1.0**: 多平台測試優化和穩定性改進 (預計 2025-09-15)
- [ ] **v2.2.0**: 選擇器精確度優化和效能提升 (預計 2025-09-30)

### ❌ Claude.ai 角色檢測問題 

#### 問題詳述
- **核心問題**：Claude.ai DOM 結構頻繁變動，導致無法正確識別 user/assistant 角色
- **表現症狀**：擴展檢測到消息內容但角色總是顯示為 `undefined`
- **技術原因**：
  - `font-claude-response` 類名經常變更
  - `data-testid` 結構不穩定
  - 角色檢測函數返回正確值但被後續邏輯覆蓋

#### 嘗試修復
1. **選擇器更新**：新增 `font-claude-response` 檢測
2. **多重檢測策略**：data attributes + CSS classes + 內容分析
3. **調試日誌強化**：詳細追蹤角色檢測過程

#### 最終狀態：⚠️ 無法穩定修復
- Claude.ai DOM 結構變動過於頻繁
- 每次 UI 更新都需要重新調整選擇器
- 建議用戶使用其他穩定平台 (ChatGPT/Gemini/Grok)

### 📝 技術債務和改進事項

1. **Claude.ai 兼容性**：需要定期更新選擇器，或等待 Claude 提供穩定 DOM 結構
2. **平台檢測精確度**：其他平台需要更多實際測試數據來優化選擇器
3. **錯誤處理強化**：平台不相容時的用戶提示機制
4. **效能監控**：多平台環境下的資源使用最佳化
5. **測試覆蓋率**：建立自動化多平台測試框架

---

## 關鍵成就總結

### 歷程回顧
- **v1.0-1.5**: ChatGPT 專用版，從基礎監控到專業交接工具
- **v2.0**: 🚀 **重大突破** - 多平台通用版，真正實現 "AI Token Watch"

### 今天最重要的成就 (2025-09-08)
**架構革命性升級**：從單一平台工具進化為**通用 AI 對話管理平台**

1. **技術架構成熟化**：模組化、可擴展、配置驅動的專業架構
2. **用戶體驗統一化**：三大穩定 AI 平台 (ChatGPT/Gemini/Grok) 享受一致的監控體驗  
3. **功能價值最大化**：專業摘要、任務交接功能跨平台通用

#### 重要認知：Claude.ai 兼容性限制
- **技術現實**：Claude.ai DOM 結構過於不穩定，無法提供可靠的角色檢測
- **解決策略**：標記為「部分支援」，建議用戶使用穩定平台
- **未來方向**：等待 Claude 提供穩定 DOM API 或官方支援

**AI Token Watch v2.0.0** 是真正的**多平台 AI 對話管理解決方案**，在穩定平台上提供完整功能 🌟

---
*最後更新：2025-09-08*
*開發者：Claude Code 協作完成*
 
---

## 2025-09-09 工作記錄 - 暫停 Claude + 修復 Gemini/Grok 計數

### ✅ 今天完成的工作

#### 1. 暫停 Claude 監控（保留未來擴充）
- `platformDetector.js`: 對 Claude 設定 `enabled: false`
- `content.js`: 若平台 `enabled === false`，不建立 HUD、不顯示 debug，乾淨早退

#### 2. Gemini/Grok 計數修復與強化
- 放寬角色限制：`role === unknown` 但內容充足時，推論為 `assistant` 以納入計數（避免 0）
- 平台提示（heuristics）：
  - Gemini：`response-container` → 視為 assistant
  - Grok：`.not-prose` → 視為 assistant；缺特徵時使用交替（user/assistant）降級
- 去重（de-dup）：同一內容只計一次（解決 Gemini 多容器重複）
- 非文字節點過濾：忽略 `svg/script/style/img/button` 等無文本元素
- Grok 選擇器優化：優先 `.not-prose`，降低掃描雜訊

#### 3. 初始化與路由穩定性
- `TokenEstimator` 支援 lazy init；`content.js` 在初始化與 SPA 路由變更時重新初始化估算平台

### 📌 實際影響
- Grok：總 tokens 可能比過去更低（因去重與雜訊過濾），更接近真實值
- Gemini：計數恢復正常；因 DOM 結構，角色顯示多偏向 assistant（不影響總量）
- ChatGPT：行為不變
- Claude：預設停用，不顯示 HUD

### ⚠️ 已知限制
- Claude：DOM 變動頻繁，角色檢測不穩定 → 暫列 Experimental/Paused
- 設定即時套用：目前只對 ChatGPT 即時廣播；Gemini/Grok 調整「Include code」後需重整頁面
- 程式碼計數：預設計入；關閉後以標記/樣式過濾，但若平台用純樣式代碼區，可能仍有殘留

### 🛠 技術細節
- platformDetector：
  - Claude `enabled: false`
  - Grok primary/content 加入 `.not-prose`
- tokenEstimator：
  - lazy init + 路由 re-init
  - 內容充分但 `role=unknown` → 推論為 `assistant` 計數
  - Gemini: `response-container` → assistant
  - Grok: `.not-prose` → assistant；交替降級
  - 去重：以內容正規化雜湊判斷
  - 預過濾：排除非文本節點、極短內容

### 📋 下一步計劃
1. Grok：視需求放寬「極短訊息」過濾（1–4 字）
2. 設定傳播：在 popup 廣播設定到 Gemini/Grok，免重整
3. 角色精準度：強化 Gemini/Grok 的 user 偵測與去重策略

---

## 版本里程碑更新
- [x] v2.0.0 多平台通用版發布 (2025-09-08)
- [x] 2025-09-09 更新：暫停 Claude + 修復 Gemini/Grok 計數（小幅強化，未變更 manifest 版本）
